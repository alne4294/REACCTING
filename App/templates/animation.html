<!DOCTYPE html>
<html>
<html>

<head>
    <meta charset="utf-8">
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <title>REACCTING GPS Dashboard</title>

    <script src="static/scriptaculous-js-1.9.0/lib/prototype.js" type="text/javascript"></script>
    <script src="static/scriptaculous-js-1.9.0/src/scriptaculous.js" type="text/javascript"></script>

    <!-- <link rel='stylesheet' href='https://api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.css'  /> -->
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7/leaflet.css" />
    <link rel="stylesheet" href="static/css/bootstrap.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="static/css/leaflet.awesome-markers.css">
    <link rel="stylesheet" type="text/css" href="static/css/animationStyle.css">

</head>

<body>

<!-- <script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.5/mapbox.js'></script> -->
<script src='static/bower_components/jquery/dist/jquery.min.js'></script>
<script>var $j=jQuery.noConflict();</script>
<script src='static/bower_components/d3/d3.min.js'></script>
<script src="http://cdn.leafletjs.com/leaflet-0.7/leaflet.js"></script>
<!-- <script src="static/Bing.js"></script>  -->
<script src="http://maps.google.com/maps/api/js?v=3&sensor=false"></script>
<script src="static/Google.js"></script>
<script src="static/leaflet.awesome-markers.js"></script>
<!-- <link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.5/mapbox.css' rel='stylesheet' /> -->

<div id='map'></div>

<div class="dateTimeSlider box" style="display: block;">
    <div class = "header"><i class=" fa fa-dashboard"></i> REACCTING GPS Dashboard <button type="button" class="btn btn-default btn-xs about" style="float:right;"> <i class=" fa fa-info"></i> </button></div>
    <div class = "sliderLabel">Slide to adjust time</div>
    <div id="zoom_slider" class="slider">
      <div class="handle"></div>
    </div>
    <div id="zoom_element"></div>
</div>

<div class="selectorBox box" style="display: block;">
    <!-- <form action="animation" method="get"> -->
    <input type="radio" name="phoneNum" value="1" checked> Phone1     <input type="radio" name="phoneNum" value="2"> Phone2<br>  
    <div class='submitWrapper'>    
      <!-- <input type="submit" class="fa" value="&#xf021; Submit"><br><br> -->
      <button type="button" class="btn btn-default btn-xs loadNewPhone"><i class=" fa fa-refresh"></i> Submit</button><br><br>
    </div>
<!--     </form> -->
    <input type="checkbox" name="households" id="households" href="#"> Households<br>
    <!-- <input type="checkbox" name="beacons" id="beacons" href="#"> Beacons<br> -->
</div>

<div class="dateTimeBox box" style="display: block;">
    <div class = "date"></div> 
    <div class = "time"><span class = "readableTime"></span></div> 
    <div class= "controls">
        <button type="button" class="btn btn-default btn-xs slower"><i class=" fa fa-backward"></i> Slower</button>
        <button type="button" class="btn btn-default btn-xs play"><i class=" fa fa-play"></i></button>
        <button type="button" class="btn btn-default btn-xs stop"><i class=" fa fa-stop"></i></button>   
        <button type="button" class="btn btn-default btn-xs faster">Faster <i class=" fa fa-forward"></i></button>   
    </div>
    <div>Time Factor: <span class = "timeFactor"></span>x</div>
</div>

<div class = 'container popup aboutPopup'>
  <div class="panel panel-primary">
  <div class="panel-heading">
    <h3 class="panel-title">About <button type="button" class="btn btn-default btn-xs close"><i class=" fa fa-times"></i></button></h3>
  </div>
  <div class="panel-body">
      <strong><p>REACCTING: GPS and Emissions Data Visualization </p></strong>

      <p>
        This visualization represents the known location and pollution exposure of a Ghanaian for a given time range.  The data is collected and analyzed by the <a href = "http://www.reaccting.com/">REACCTING</a> research group. The source code is available on <a href = "https://github.com/alne4294/reaccting_webApp">GitHub</a>. <br>
      </p>
      <p>
        <span><strong>Summary of REACCTING Research Objectives: &nbsp;</strong>&nbsp;</span><br>
        <span style="font-size:x-small"><strong>R</strong>easearch of <strong>E</strong>missions, <strong>A</strong>ir Quality, <strong>C</strong>limate, and <strong>C</strong>ooking <strong>T</strong>echnologies <strong>I</strong>n <strong>N</strong>orthern <strong>G</strong>hana</span>
      </p>
      <p>
          According to recent reports, nearly three billion people in the developing world cook food and heat their homes with open fires or cookstoves that are fueled by solid biofuels. The smoke exposure from these activities is estimated to lead to approximately four million premature deaths each year. The emissions from these processes also add significantly to global emissions of greenhouse gases, short-lived climate forcing agents, and air pollutants. However, emission estimates from these processes, and their atmospheric impacts, are still highly uncertain. Furthermore, stove technologies exist that enable reductions in the amount of fuel used for cooking, and in emissions. Yet, the extent to which these technologies will be utilized, change emissions, and impact health and atmospheric composition is unclear.
      </p>
      <p>
          <span style="font-size:x-small"> This web application was created by <a href = "http://alexianewgord.com">Alexia Newgord</a> in partial fulfillment of her undergraduate honors thesis at the University of Colorado, Boulder.</span>
      </p>
  </div>
</div>

<script>

  // custom javascript

  //STARTING POINT, will run after DOM loads
  $j(function() {

    //retrieve the data for the households
    getHouseholdData();

    //Default phoneNume (if no params are provided)
    var phoneNum = 1;

    var params = getQueryParams(window.location.search);
    console.log(params);
    //handle the phoneNum parameter if it exists
    if(Object.keys(params).length){
      phoneNum = params.phoneNum;
      //Set radio button to the correct num
      //http://stackoverflow.com/questions/6549712/grab-url-parameters-to-maintain-search-form-options-using-jquery-or-javascript
      $j('input[name=phoneNum][value='+phoneNum+']').attr('checked', 'checked');
    }

    console.log('About to animate for Phone'+phoneNum.toString());
    getPhoneData(phoneNum);
  });

  //Pull params out of url and decode if needed
  function getQueryParams(qs) {
    //http://stackoverflow.com/questions/979975/how-to-get-the-value-from-the-url-parameter
    qs = qs.split("+").join(" ");
    var params = {}, tokens,
        re = /[?&]?([^=]+)=([^&]*)/g;
    while (tokens = re.exec(qs)) {
        params[decodeURIComponent(tokens[1])]
            = decodeURIComponent(tokens[2]);
    }
    return params;
  }

  function getPhoneData(phoneNum){
    d3.json("/api/1.0/mongoWebApp/getPhoneData/"+phoneNum, function(docs) {
      
      //docs.data is an array of objects, where each obj is a csv row
      var dataObjs = (docs.data);
      // console.log(typeof(dataObjs));

      var numRecords = dataObjs.length;
      var lats  = [];
      var longs = [];
      var records = [];
      var latTot = 0;
      var lonTot = 0;

      for (var i = 0; i < numRecords; i++){
        var record = dataObjs[i];
        if (i<5){
          console.log("RECORD");
          console.log(record);
        }
        var lat = Number(record.lat);
        var lon = Number(record.lon);

        //Check that our coordinates are numerical and within the acceptable area
        if(!isNaN(lat) && lat<11.109684643110414 && lat>10.478359299402134){
          if(!isNaN(lon) && lon<-0.693511962890625 && lon>-1.41998291015625){

            //Get running total of lat and lon so we can get avg to know where to center the map
            latTot += lat;
            lonTot += lon;

            lats.push(lat);
            longs.push(lon);
            records.push(record);
          }
        }
      }

      console.log("Started with: " + numRecords + " records");
      var prunedNumRecords = lats.length;
      console.log(prunedNumRecords + " were permissable")

      var latAvg = latTot/prunedNumRecords;
      var lonAvg = lonTot/prunedNumRecords;

      //Call from here to avoid asynchronous behavior
      animatePhoneData(lats, longs, records, latAvg, lonAvg);

    });
  }


  var households;

  var householdMarker = L.AwesomeMarkers.icon({
    icon: 'home', 
    markerColor: 'blue',
    prefix: 'fa', 
    iconColor: 'white'
  });

  // var marker = L.marker([0,0], {icon: phoneMarker}).addTo(map)
  //     .bindPopup('Phone');

  function getHouseholdData(phoneNum){
    //Define the household layer

    d3.json("/api/1.0/mongoWebApp/getHouseholdData", function(docs) {
      
      //docs.data is an array of objects, where each obj is a csv row
      var dataObjs = (docs.data);
      console.log(typeof(dataObjs));
      console.log(dataObjs);
      var markerArray = [];

      var numHouseholds = dataObjs.length;

      for (var i = 0; i < numHouseholds; i++){

        //Add each marker to the map layer
        var household = dataObjs[i];

        if (i<5){
          console.log("HOUSEHOLD");
          console.log(household);
        }
        var lat = Number(household.latitude);
        var lon = Number(household.longitude);

        marker = L.marker([lat, lon], {icon: householdMarker}).bindPopup(
           "<strong>Name </strong>" + household.househnam + "<br>"
           + "<strong>ID </strong>" + household.hhid + "<br>"
           + "<strong>Size </strong>" + household.hhsize + "<br>"
           + "<strong>Choice </strong>" + household.choiceversion);

        markerArray.push(marker);

      }

      console.log("Num households");
      console.log(numHouseholds);

      // var aa = L.marker([10.88107, -1.08795]).bindPopup('AA'),
      //   bb = L.marker([10.89107, -1.08795]).bindPopup('BB');
      households = L.layerGroup(markerArray);
    });
  }

  function animatePhoneData(lats, longs, records, latAvg, lonAvg){

    // add a Google Maps tile layer
    var zoomLevel = 13; //higher zoom gets closer in
    var map = new L.Map('map', {center: new L.LatLng(latAvg, lonAvg), zoom: zoomLevel});
    var osm = new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
    var ggl = new L.Google();
    var ggl2 = new L.Google('TERRAIN');
    map.addLayer(ggl);
    map.addControl(new L.Control.Layers( {'OSM':osm, 'Google':ggl, 'Google Terrain':ggl2}, {}));

    // add a Bing Maps tile layer
    // var map = new L.Map('map', {center: new L.LatLng(10.9100667, -1.0007569), zoom: 12 });
    // var bing = new L.BingLayer('Apb30DxKsPr3GNnsoElz70LlkgOSsKZe3PjWEa9__-huHzyMYYQB45vP8m7MjL3c');
    // map.addLayer(bing);

    // add a MapBox tile layer
    // L.mapbox.accessToken = 'pk.eyJ1IjoiYWxuZTQyOTQiLCJhIjoiZERWYV8yZyJ9.9Dp7x2OGFrLO6ZIunDSHyQ';
    // var map = L.mapbox.map('map', 'alne4294.l9ebdngb').setView([10.9100667, -1.0007569], 12);

    // add an OpenStreetMap tile layer
    // L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
    //     attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
    // }).addTo(map);


    //=========================================================================
    //figure out the points we are going to iterate through

    // Generate a GeoJSON line. You could also load GeoJSON via AJAX
    // or generate it some other way.
    var geojson = { type: 'LineString', coordinates: [] };

    console.log(lats);
    console.log(longs);

    var start = [0,0];
    var momentum = [.001, .001];
    var timeFactor = 8;
    $j('.timeFactor').html(timeFactor); //Displays the timeFactor in the UI.
    var pace = 30; //Higher number is a slower pace


    for (var i = 0; i < lats.length; i++){

      //Push the start of the line, then start moving towards the next point
      start[0] = lats[i];
      start[1] = longs[i];

      geojson.coordinates.push(start.slice());
     
      // var latMom  = Math.abs(lats[i+1]  - lats[i])/pace;
      // var longMom = Math.abs(longs[i+1] - longs[i])/pace;
      // momentum = [latMom, longMom];

      // //The direction of the momentum depends on the direction that we're going
      // //Note: since we've scaled the momentum for N/S and E/W, we only need to check
      // //one of them to determine if we've reached our destination

      // //NORTHEAST
      // if(lats[i] <= lats[i+1] && longs[i] <= longs[i+1]){
      //   while(start[0] < lats[i+1]){
      //     // Use the momentum to smooth transitions
      //     start[0] += momentum[0];
      //     start[1] += momentum[1];
      //     geojson.coordinates.push(start.slice());
      //   } 
      // }

      // //NORTHWEST
      // else if(lats[i] <= lats[i+1] && longs[i] >= longs[i+1]){
      //   while(start[0] < lats[i+1]){
      //     // Use the momentum to smooth transitions
      //     start[0] += momentum[0];
      //     start[1] -= momentum[1];
      //     geojson.coordinates.push(start.slice());
      //   } 
      // }

      // //SOUTHEAST
      // else if(lats[i] >= lats[i+1] && longs[i] <= longs[i+1]){
      //   while(start[0] > lats[i+1]){
      //     // Use the momentum to smooth transitions
      //     start[0] -= momentum[0];
      //     start[1] += momentum[1];
      //     geojson.coordinates.push(start.slice());
      //   } 
      // }

      // //SOUTHWEST
      // else if(lats[i] >= lats[i+1] && longs[i] >= longs[i+1]){
      //   while(start[0] > lats[i+1]){
      //     // Use the momentum to smooth transitions
      //     start[0] -= momentum[0];
      //     start[1] -= momentum[1];
      //     geojson.coordinates.push(start.slice());
      //   } 
      // }

    }

    console.log(geojson);

    // Add this generated geojson object to the map.
    L.geoJson(geojson).addTo(map);

    //=========================================================================
    //create marker and establish somewhat global vars

    // Create a counter with a value of 0.
    var j = 0;
    var numCoordinates = geojson.coordinates.length;
    console.log(geojson.coordinates.length);

    var phoneMarker = L.AwesomeMarkers.icon({
      icon: 'mobile-phone', 
      markerColor: 'red',
      prefix: 'fa', 
      iconColor: 'white'
    });

    var marker = L.marker([0,0], {icon: phoneMarker}).addTo(map)
        .bindPopup('Phone');

    var circle = L.circle([0,0], 250, {
        fill: true,
        color: 'gold',
        fillColor: 'yellow',
        fillOpacity: 0.18
    }).addTo(map);

    //=========================================================================
    //slider
    var zoom_slider = $('zoom_slider');
    var sliderHandle;

    (function() {
      sliderHandle = new Control.Slider(zoom_slider.down('.handle'), zoom_slider, {
        range: $R(0, numCoordinates),
        sliderValue: 0,
        onSlide: function(value) {
          j = parseInt(value);
          updateMarker();
          updateTimer();
        },
        onChange: function(value) { 
          j = parseInt(value);
          updateMarker();
          updateTimer();
        }
      });
    })();

    //=========================================================================
    //let's map!

    // map.on("layers-add-result", initSlider);

    var delay = 0; //Will pause execution if set to !0
    var timeoutHandle; //Responsible for delaying execution
    tick();

    function tick() {
        updateMarker();
        sliderHandle.setValue(j);
        timeoutHandle = setTimeout(function(){
          updateTimer();
          // Move to the next point of the line
          // until `j` reaches the length of the array.
          if ((j+=timeFactor) < numCoordinates) setTimeout(tick, (1000/timeFactor));
        }, delay);
    }

    function updateMarker(){
        // Set the marker to be at the same point as one
        // of the segments or the line.
        if(geojson.coordinates[j] && geojson.coordinates[j][0] && geojson.coordinates[j][1]){
          marker.setLatLng(L.latLng(
              geojson.coordinates[j][0],
              geojson.coordinates[j][1]));

          circle.setLatLng(L.latLng(
              geojson.coordinates[j][0],
              geojson.coordinates[j][1]))
        }

        marker.bindPopup((L.latLng(
              geojson.coordinates[j][0],
              geojson.coordinates[j][1])).toString());

        if(records[j] && records[j].gpsacc){
          var accuracy = Number(records[j].gpsacc)
          if (!isNaN(accuracy) && accuracy <= 100){
            circle.setRadius( 250+(.35*accuracy) )
          }
        }

    }

    function updateTimer() {
        // time.add('minutes',1);
        if(records[j] && records[j].time && records[j].date){
          $j('.readableTime').text(records[j].time);
          $j('.date').text(records[j].date);
        }
        // timer = setTimeout(function(){updateTimer()},(1000/timeFactor));
    }


    //=========================================================================
    //listeners 

    $j('.slower').click(function(){
        if(timeFactor > 1){
            timeFactor = (timeFactor/2);  
        };
        $j('.timeFactor').html(timeFactor);
    });

    $j('.faster').click(function(){
        timeFactor = (timeFactor * 2);
        $j('.timeFactor').html(timeFactor);
    });

    $j('.play').click(function(){
        delay = 0; //Resume execution
        if(timeoutHandle){
          clearTimeout(timeoutHandle);
          timeoutHandle = null;
        }
        tick();

        console.log("play ==============");
        console.log(delay);
        console.log(timeoutHandle);
    });

    $j('.stop').click(function(){
        delay = 49999861776383; //Maximum allowable delay
        console.log("stop ==============");
    });

    $j('.about').click(function(){
      $j('.aboutPopup').fadeIn();
    });

    $j('.aboutPopup .close').click(function(){
      $j('.aboutPopup').fadeOut();
    });


    //phone selection

    //helper function, load new URL
    function loadUrl(newLocation){
        window.location = newLocation;
        return false;
    }

    $j('.loadNewPhone').click(function(){
        //Determine which phone number is selected
        var phoneNum = document.getElementsByName('phoneNum');
        for (var i = 0, length = phoneNum.length; i < length; i++) {
            if (phoneNum[i].checked) {
                console.log(phoneNum[i].value);
                // only one radio can be logically checked, don't check the rest
                break;
            }
        }
        //Create a URL with the phoneNum as a parameter
        var url = window.location.href; 
        if (url.indexOf('?') != -1){
          //If param exists, just take out the part of the url that we wanted
          var urlArray = url.split('?');
          url = urlArray[0];
          console.log(url);
        }
        url += '?phoneNum='+((phoneNum[i].value).toString());

        loadUrl(url);
    });

    
    //beacon info
    var aa = L.marker([10.88107, -1.08795]).bindPopup('AA'),
      bb = L.marker([10.89107, -1.08795]).bindPopup('BB');
    var beacons = L.layerGroup([aa, bb]);

    $j("#beacons").change(function(event) {
      event.preventDefault();
      if(map.hasLayer(beacons)) {
          $j(this).removeClass('selected');
          map.removeLayer(beacons);
      } else {
          map.addLayer(beacons);        
          $j(this).addClass('selected');
      }
    });

    //household info
    $j("#households").change(function(event) {

      event.preventDefault();

      console.log("Has layer?");
      console.log(map.hasLayer(households));

      if(map.hasLayer(households)) {
          $j(this).removeClass('selected');
          map.removeLayer(households);
      } else {
          map.addLayer(households);        
          $j(this).addClass('selected');
      }
    });
  }
</script>

</body>
</html>